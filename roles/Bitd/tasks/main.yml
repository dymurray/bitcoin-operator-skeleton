---
- name: create pvc
  k8s:
    definition:
      kind: PersistentVolumeClaim
      apiVersion: v1
      metadata:
        name: bitcoin
        namespace: "{{ meta.namespace }}"
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 20Gi

# tasks file for Bitd
- name: start bitd
  k8s:
    definition:
      kind: Deployment
      apiVersion: apps/v1
      metadata:
        name: '{{ meta.name }}-bitd'
        namespace: '{{ meta.namespace }}'
      spec:
        selector:
          matchLabels:
            app: bitd
        template:
          metadata:
            labels:
              app: bitd
          spec:
            containers:
            - name: bitd
              image: "docker.io/dymurray/bitcoin-sv-bitd"
              ports:
                - containerPort: 8332
              volumeMounts:
                - name: bitcoin
                  mountPath: /root/.bitcoin
            volumes:
              - name: bitcoin
                persistentVolumeClaim:
                  claimName: bitcoin
  register: dep

- name: create service
  k8s:
    definition:
      kind: Service
      apiVersion: v1
      metadata:
        name: '{{ meta.name }}-bitd'
        namespace: '{{ meta.namespace }}'
      spec:
        type: NodePort
        selector:
          app: bitd
        ports:
        - protocol: TCP
          port: 8332
          targetPort: 8332
          name: rpc
  register: svc
